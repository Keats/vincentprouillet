<!DOCTYPE html>
<html lang="en-gb">
    <head>
      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="
    A direnv introduction and comparison with dotenv
">
      <meta name="author" content="Vincent Prouillet">
      <title>Vincent Prouillet: Developer &amp; Entrepreneur</title>
      <link rel="stylesheet" href="https://www.vincentprouillet.com/site.css?h=6dba58370284a334effb" />
      <link rel="shortcut icon" type="image/png" href="https://www.vincentprouillet.com/favicon.ico"/>
      <link href="https://www.vincentprouillet.com/rss.xml" rel="feed" type="application/rss+xml" title="Vincent Prouillet: Developer &amp; Entrepreneur" />
    </head>

    <header id="header">
        <h1 class="logo"><a href="/">Vincent Prouillet</a></h1>
        <ul>
            <li><a href="/blog/">Blog</a></li>
        </ul>
    </header>

    <div id="content">
        
    <div class="post">
        <div class="post__title">
            <h1>Managing environment variables with direnv</h1>
            <div class="post__meta">
                2019-05-30
                
            </div>
            <hr />
        </div>

        <div class="post__body">
            <p>Following the <a href="https://12factor.net/config">Twelve-Factors app</a>, most web applications
are storing configuration in environment variables rather than in a repository. It is possible
to store secrets securely in a repository with <a href="https://github.com/AGWA/git-crypt">git-crypt</a> but that will likely be the topic
of another article.</p>
<p>While in CI and on servers loading those environment variables happen automatically, loading them on your computer is problematic. The
most popular approach is <code>dotenv</code>: you store your environment variables in a <code>.env</code> file and a library in your project will look for
it and load them. A <code>.env</code> file sample:</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">REDIS_URL</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">blabla
</span><span style="color:#7f8989;"># Make sure this is not used in other environments
</span><span style="color:#5597d6;">APP_SECRET</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">hunter2
</span><span style="color:#5597d6;">TRIAL_DAYS_LENGTH</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">14
</span></code></pre>
<p>And, for example in the JavaScript implementation, they can be loaded by adding <code>require('dotenv').config()</code> to your project, as early as possible.
As you can see, this adds a dependency to your project that is only used in development: in CI variables are likely to be set in the CI itself and in production
by whatever provisioning tool you are using.</p>
<p>Enter <a href="https://direnv.net/">direnv</a>.</p>
<p>It starts the same way as <code>dotenv</code>: you write your variables in a <code>.envrc</code> file which is almost identical to the example above: entries have an <code>export</code> keyword first.</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#668f14;">export </span><span style="color:#5597d6;">REDIS_URL</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">blabla
</span><span style="color:#7f8989;"># Make sure this is not used in other environments
</span><span style="color:#668f14;">export </span><span style="color:#5597d6;">APP_SECRET</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">hunter2
</span><span style="color:#668f14;">export </span><span style="color:#5597d6;">TRIAL_DAYS_LENGTH</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">14
</span></code></pre>
<p>What sets it apart is how it loads the variables.
You first need to install <code>direnv</code>, which is a cross-platform binary available on most package managers as well as set up a hook in your bash/zsh/fish config.
This might sound complex but you only need to do this setup once per computer and it actually takes less than a minute. The hook is fast enough that it
is imperceptible - no need to worry about terminal slowdown.</p>
<p>Now that you have the <code>direnv</code> hook, if you <code>cd</code> to a directory with a <code>.envrc</code> you will see:</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">$</span><span> direnv: error .envrc is blocked. Run `</span><span style="color:#5597d6;">direnv</span><span> allow` to approve its content.
</span></code></pre>
<p>As mentioned in the message, <code>direnv</code> will not automatically load the variables found: you first need to allow the <code>.envrc</code> file. You will need
to run <code>direnv allow</code> every time the <code>.envrc</code> is modified. Since <code>direnv</code> loads the variable automatically, this is needed for security as any
repo could run commands on your machine otherwise.</p>
<p>And that's it you're done. Every time you will <code>cd</code> in a directory, it will automatically load variables found in <code>.envrc</code> and unload them when moving
out of the directory:</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">$</span><span> cd my-repo/
</span><span style="color:#5597d6;">direnv:</span><span> loading .envrc
</span><span style="color:#5597d6;">direnv:</span><span> export +AWS_ACCESS_KEY_ID +AWS_SECRET_ACCESS_KEY +RUST_LOG +SENTRY_DSN
</span><span>
</span><span style="color:#5597d6;">$</span><span> cd ..
</span><span style="color:#5597d6;">direnv:</span><span> unloading
</span></code></pre>
<p>You get the benefits of environment variables for configuration without having to add a dependency to your project.
I was actually using <code>direnv</code> before hearing about <code>dotenv</code>: <a href="https://github.com/Keats/dbmigrate/pull/14">https://github.com/Keats/dbmigrate/pull/14</a> and I still don't really see myself using <code>dotenv</code> over it.
I'm guessing the advantage of <code>dotenv</code> is if you are launching things from an IDE directly, using Docker or at companies restricting what can be installed on a machine.</p>
<p>If this is not your case, I highly recommend <code>direnv</code>.</p>

        </div>
    </div>

    </div>

  <body>
  </body>
</html>
