<!DOCTYPE html>
<html lang="en-gb">
    <head>
      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="
    Tools and tricks I use to make tests fast and easy to write in Django projects
">
      <meta name="author" content="Vincent Prouillet">
      <title>Vincent Prouillet: Developer &amp; Entrepreneur</title>
      <link rel="stylesheet" href="https://www.vincentprouillet.com/site.css?h=6dba58370284a334effb" />
      <link rel="shortcut icon" type="image/png" href="https://www.vincentprouillet.com/favicon.ico"/>
      <link href="https://www.vincentprouillet.com/rss.xml" rel="feed" type="application/rss+xml" title="Vincent Prouillet: Developer &amp; Entrepreneur" />
    </head>

    <header id="header">
        <h1 class="logo"><a href="/">Vincent Prouillet</a></h1>
        <ul>
            <li><a href="/blog/">Blog</a></li>
        </ul>
    </header>

    <div id="content">
        
    <div class="post">
        <div class="post__title">
            <h1>Testing Django projects</h1>
            <div class="post__meta">
                2013-09-02
                
            </div>
            <hr />
        </div>

        <div class="post__body">
            <h2 id="introduction">Introduction<a class="zola-anchor" href="#introduction" aria-label="Anchor link for: introduction">ðŸ”—</a></h2>
<p>This post will introduce what I consider the best practices when testing a Django project.
As you've probably read 1000 times, testing is very important because without them, deploying
is pretty much a gamble on whether something is going to break or not.
There are a few different type of tests:</p>
<ul>
<li>unit tests: test a specific function, one path at a time (by path I mean if/else conditions)</li>
<li>integration tests: test a whole user action, from the template to the model</li>
</ul>
<p>What I do is unit tests all the functions I write (except the views) and integration tests for the views.
This ensures you got everything covered.</p>
<p>Whether you write the tests before the code (if you're doing TDD) or after is up to you.
I like doing TDD for 'easy' code when I know how I am going to do it but otherwise I first write a quick draft
that works, then code it again the TDD way.
I found that it results in better code using that process but again it's up to you.</p>
<h2 id="basics">Basics<a class="zola-anchor" href="#basics" aria-label="Anchor link for: basics">ðŸ”—</a></h2>
<h3 id="structure">Structure<a class="zola-anchor" href="#structure" aria-label="Anchor link for: structure">ðŸ”—</a></h3>
<p>I like putting all the tests in a top level package (ie at the same level as the apps) because I find it easier
to navigate.
Make sure you have one test file for models, views, forms, etc rather than putting it in a single file like the
default django does because it quickly becomes impossible to work with.</p>
<h3 id="tools">Tools<a class="zola-anchor" href="#tools" aria-label="Anchor link for: tools">ðŸ”—</a></h3>
<p>Lots of packages exist to make testing easier.
Here are the ones I use :</p>
<ul>
<li><a href="http://factoryboy.readthedocs.org/en/latest/" title="factory boy">factory boy</a>: create objects easily (no more fixtures)</li>
<li><a href="https://github.com/jezdez/django-discover-runner" title="django-discover-runner">django-discover-runner</a>: enhancement of the django test runner (to allow putting tests wherever you want), it will become
the default test runner starting 1.6</li>
<li><a href="http://mock.readthedocs.org/en/latest/" title="mock">mock</a>: mocking library, for when you don't really want to call some functions (usually external services), part of python standard library starting 3.3</li>
<li><a href="https://pypi.python.org/pypi/django-webtest" title="django-webtest">django-webtest</a>: makes integration testing of views easier</li>
<li><a href="http://nedbatchelder.com/code/coverage/" title="coverage">coverage</a>: for when you want to know whether you're getting close to 100% coverage or not</li>
</ul>
<p>I also like to modify the manage.py to ensure I don't type to type the settings file to use, it looks like this :</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#7f8989;">#!/usr/bin/env python
</span><span style="color:#72ab00;">import </span><span>os
</span><span style="color:#72ab00;">import </span><span>sys
</span><span>
</span><span style="color:#72ab00;">if </span><span style="color:#a2a001;">__name__ </span><span style="color:#72ab00;">== </span><span style="color:#d07711;">&quot;__main__&quot;</span><span>:
</span><span>
</span><span>    </span><span style="color:#72ab00;">if </span><span>sys.argv[</span><span style="color:#b3933a;">1</span><span>] </span><span style="color:#72ab00;">== </span><span style="color:#d07711;">&#39;test&#39;</span><span>:
</span><span>        os.environ.</span><span style="color:#5597d6;">setdefault</span><span>(</span><span style="color:#d07711;">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span>, </span><span style="color:#d07711;">&quot;myproject.settings.test&quot;</span><span>)
</span><span>    </span><span style="color:#72ab00;">else</span><span>:
</span><span>        os.environ.</span><span style="color:#5597d6;">setdefault</span><span>(</span><span style="color:#d07711;">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span>, </span><span style="color:#d07711;">&quot;myproject.settings.dev&quot;</span><span>)
</span><span>
</span><span>    </span><span style="color:#72ab00;">from </span><span>django.core.management </span><span style="color:#72ab00;">import </span><span>execute_from_command_line
</span><span>
</span><span>    </span><span style="color:#5597d6;">execute_from_command_line</span><span>(sys.argv)
</span></code></pre>
<h3 id="tips-for-having-and-keeping-fast-tests">Tips for having (and keeping) fast tests<a class="zola-anchor" href="#tips-for-having-and-keeping-fast-tests" aria-label="Anchor link for: tips-for-having-and-keeping-fast-tests">ðŸ”—</a></h3>
<p>Nothing is worse than having a test suite slow you down when developing (especially if you're doing TDD).
Here are a few of the settings I use to speed it up</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#7f8989;"># IN-MEMORY TEST DATABASE
</span><span style="color:#7f8989;"># If you&#39;re not using DB specific features
</span><span style="color:#5597d6;">DATABASES </span><span style="color:#72ab00;">= </span><span>{
</span><span>    </span><span style="color:#d07711;">&quot;default&quot;</span><span>: {
</span><span>        </span><span style="color:#d07711;">&quot;ENGINE&quot;</span><span>: </span><span style="color:#d07711;">&quot;django.db.backends.sqlite3&quot;</span><span>,
</span><span>        </span><span style="color:#d07711;">&quot;NAME&quot;</span><span>: </span><span style="color:#d07711;">&quot;:memory:&quot;</span><span>,
</span><span>        </span><span style="color:#d07711;">&quot;USER&quot;</span><span>: </span><span style="color:#d07711;">&quot;&quot;</span><span>,
</span><span>        </span><span style="color:#d07711;">&quot;PASSWORD&quot;</span><span>: </span><span style="color:#d07711;">&quot;&quot;</span><span>,
</span><span>        </span><span style="color:#d07711;">&quot;HOST&quot;</span><span>: </span><span style="color:#d07711;">&quot;&quot;</span><span>,
</span><span>        </span><span style="color:#d07711;">&quot;PORT&quot;</span><span>: </span><span style="color:#d07711;">&quot;&quot;</span><span>,
</span><span>    },
</span><span>}
</span><span>
</span><span style="color:#7f8989;"># FAST HASHING FOR PASSWORDS
</span><span style="color:#5597d6;">PASSWORD_HASHERS </span><span style="color:#72ab00;">= </span><span>(
</span><span>    </span><span style="color:#d07711;">&#39;django.contrib.auth.hashers.UnsaltedMD5PasswordHasher&#39;</span><span>,
</span><span>)
</span><span>
</span><span style="color:#7f8989;"># Use syncdb instead of migrate if you&#39;re using South
</span><span style="color:#5597d6;">SOUTH_TESTS_MIGRATE </span><span style="color:#72ab00;">= </span><span style="color:#b3933a;">False
</span></code></pre>
<p>Also, be careful when testing with saving objects : only do it if it's necessary (if you're using factory_boy, it means using MyFactory.build() instead
MyFactory()).</p>
<h2 id="testing">Testing<a class="zola-anchor" href="#testing" aria-label="Anchor link for: testing">ðŸ”—</a></h2>
<h3 id="a-form-model">A form/model<a class="zola-anchor" href="#a-form-model" aria-label="Anchor link for: a-form-model">ðŸ”—</a></h3>
<p>I group these 2 as they are quite similar : basically if you're writing a method on one of those (be it a custom clean() on a form or a method on a method
to deal with some business logic), it should have a test for each of the different 'paths' it contains.
By path I mean every branch of code exists, which ideally range from 1 to 3 (more than that and it could mean that the method does too much).
Those are unit tests, testing one thing at a time so if a test fails, there should only one possible reason.</p>
<h3 id="a-view">A view<a class="zola-anchor" href="#a-view" aria-label="Anchor link for: a-view">ðŸ”—</a></h3>
<p>This is where webtest shines.
Most of the tests I write are actually integration tests, testing thoroughly every path of each view.
For example, for a FormView you will have 3 paths : first GET, success POST and POST with errors.
By testing all of the branches you reduce the likelihood of unexpected exceptions (oxymoron I know, exceptions are rarely expected).
Webtest allow you to easily login (no need for self.client.login(...) anymore), easily grab/submit forms and access the DOM.</p>
<p>Here's an example of testing a landing page with an email field from a model called Interest :</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#72ab00;">class </span><span style="color:#c23f31;">PublicViewsTests</span><span>(</span><span style="font-style:italic;color:#b06936;">WebTest</span><span>):
</span><span>    </span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">test_anonymous_can_access_landing_page</span><span>(</span><span style="color:#5597d6;">self</span><span>):
</span><span>        url </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">reverse</span><span>(</span><span style="color:#d07711;">&#39;public:landing-page&#39;</span><span>)
</span><span>        response </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">self</span><span>.app.</span><span style="color:#5597d6;">get</span><span>(url)
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">assertEqual</span><span>(response.status_code, </span><span style="color:#b3933a;">200</span><span>)
</span><span>
</span><span>    </span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">test_anonymous_can_add_email</span><span>(</span><span style="color:#5597d6;">self</span><span>):
</span><span>        url </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">reverse</span><span>(</span><span style="color:#d07711;">&#39;public:landing-page&#39;</span><span>)
</span><span>        form </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">self</span><span>.app.</span><span style="color:#5597d6;">get</span><span>(url).form
</span><span>        form[</span><span style="color:#d07711;">&#39;email&#39;</span><span>] </span><span style="color:#72ab00;">= </span><span style="color:#d07711;">&#39;easy@abc.com&#39;
</span><span>        form.</span><span style="color:#5597d6;">submit</span><span>()
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">assertEqual</span><span>(Interest.objects.</span><span style="color:#5597d6;">count</span><span>(), </span><span style="color:#b3933a;">1</span><span>)
</span><span>
</span><span>    </span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">test_invalid_interest_email_error</span><span>(</span><span style="color:#5597d6;">self</span><span>):
</span><span>        url </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">reverse</span><span>(</span><span style="color:#d07711;">&#39;public:landing-page&#39;</span><span>)
</span><span>        form </span><span style="color:#72ab00;">= </span><span style="color:#5597d6;">self</span><span>.app.</span><span style="color:#5597d6;">get</span><span>(url).form
</span><span>        form[</span><span style="color:#d07711;">&#39;email&#39;</span><span>] </span><span style="color:#72ab00;">= </span><span style="color:#d07711;">&#39;easyabc.com&#39;
</span><span>        response </span><span style="color:#72ab00;">= </span><span>form.</span><span style="color:#5597d6;">submit</span><span>().</span><span style="color:#5597d6;">follow</span><span>()
</span><span>
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">assertEqual</span><span>(Interest.objects.</span><span style="color:#5597d6;">count</span><span>(), </span><span style="color:#b3933a;">0</span><span>)
</span><span>        </span><span style="color:#7f8989;"># you could look in the dom for your error class or just use assertTemplateUsed instead
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">assertContains</span><span>(response, </span><span style="color:#d07711;">&#39;invalid&#39;</span><span>)
</span></code></pre>
<p>If I wanted to be logged in, I would just need to pass my user object as a parameter to the get, ie self.app.get(url, user=self.user) for example.</p>
<h3 id="mocking">Mocking<a class="zola-anchor" href="#mocking" aria-label="Anchor link for: mocking">ðŸ”—</a></h3>
<p>Sometimes you want to mock things it out. Things like call to a 3rd party service that can take time and require an internet connection.
You do not want to mock your own services though unless you have proper integration tests somewhere.
In the following example, I will mock a method from the Stripe API to prevent it from actually calling Stripe.</p>
<pre data-lang="python" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-python "><code class="language-python" data-lang="python"><span>    @</span><span style="color:#5597d6;">patch</span><span>(</span><span style="color:#d07711;">&#39;stripe.Customer.retrieve&#39;</span><span>)
</span><span>    @patch.</span><span style="color:#5597d6;">object</span><span>(stripe.Customer, </span><span style="color:#d07711;">&#39;update_subscription&#39;</span><span>)
</span><span>    </span><span style="color:#72ab00;">def </span><span style="color:#c23f31;">test_subscribe_different_subscription</span><span>(</span><span style="color:#5597d6;">self</span><span>, </span><span style="color:#5597d6;">UpdateSubscriptionMock</span><span>, </span><span style="color:#5597d6;">CustomerRetrieveMock</span><span>):
</span><span>        </span><span style="color:#7f8989;">&quot;&quot;&quot;
</span><span style="color:#7f8989;">        Changing to a different plan (or no previous plan) should call
</span><span style="color:#7f8989;">        Stripe and save it locally
</span><span style="color:#7f8989;">        &quot;&quot;&quot;
</span><span>        CustomerRetrieveMock.return_value </span><span style="color:#72ab00;">= </span><span>StripeTest.</span><span style="color:#5597d6;">get_customer_response</span><span>()
</span><span>        UpdateSubscriptionMock.return_value </span><span style="color:#72ab00;">= </span><span>StripeTest.</span><span style="color:#5597d6;">get_subscription_response</span><span>()
</span><span>
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">_subscribe_user</span><span>()
</span><span>        </span><span style="color:#5597d6;">StripePlanFactory</span><span>(</span><span style="color:#5597d6;">code</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&#39;big&#39;</span><span>)
</span><span>        </span><span style="color:#5597d6;">self</span><span>.customer.</span><span style="color:#5597d6;">subscribe</span><span>(</span><span style="color:#d07711;">&#39;big&#39;</span><span>)
</span><span>
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">assertTrue</span><span>(CustomerRetrieveMock.called)
</span><span>        </span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#5597d6;">assertTrue</span><span>(UpdateSubscriptionMock.called)
</span></code></pre>
<p>Mocking 2 things here :</p>
<ul>
<li>a class method (stripe.Customer.retrieve)</li>
<li>a method (update_subscription of stripe.Customer)</li>
</ul>
<p>To accomplish that, you just need to add the right decorators (look into the doc for more info), add the mocks in the test parameters (order matters of course)
and then define a return_value to these mocks.
At the end of the tests I'm just making sure both methods were called and that's it.</p>
<h2 id="conclusion">Conclusion<a class="zola-anchor" href="#conclusion" aria-label="Anchor link for: conclusion">ðŸ”—</a></h2>
<p>That's it for how I test django apps, if you want more details or have better ideas, feel free to ask/share !</p>

        </div>
    </div>

    </div>

  <body>
  </body>
</html>
